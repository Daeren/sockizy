"use strict";function _possibleConstructorReturn(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r}function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=function(){function e(e,r){var t=[],n=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(t.push(o.value),!r||t.length!==r);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}return t}return function(r,t){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),io=function(){var e=function(){function e(e){function r(e,r){for(var t=Array.isArray(r),n=void 0,o=void 0,f=void 0,l=void 0,h=void 0,b=void 0,g=void 0,k=void 0,E=s,A=a,m=void 0,T=void 0;E--;){o=u[E];var U=_slicedToArray(o,7);switch(f=U[0],l=U[1],U[2],h=U[3],b=U[4],g=U[5],k=U[6],n=r[t?E:f],l){case _:var S=n?h.write(n):0,B=g.byteLength;b&&b.length===S||(b=o[4]=new Uint8Array(B+S)),g[0]=S,b[0]=k[0],b[1]=k[1],i&&(g.reverse(),h.swap16());for(var C=S;C--;)b[B+C]=h[C];B+=S;break;default:h[0]=n,i&&h.byteLength>1&&h.reverse()}if(m=b.length,y)for(T=0;m--;)y[A++]=b[T++];else c[E]=b,A+=m}if(y)return y[0]=e,y;var M=v&&v.length===A?v:p&&p.length===A?p:null,L=a;for(E=s,M||(M=v=new Uint8Array(A));E--;)for(var O=c[E],P=0,I=O.length;P<I;P++)M[L++]=O[P];return d[0]=A,M[0]=w[0],M[1]=w[1],M[2]=e,M}function t(e,r){if(r=r||f,!e||"object"!==(void 0===e?"undefined":_typeof(e))||!h&&e.byteLength!==l||e.byteLength<l)return null;if(!s)return r;if(e instanceof ArrayBuffer){var t=p&&p.length===e.length?p:v&&v.length===e.length?v:null;t?(t.set(e),e=t):e=p=new Uint8Array(e)}for(var o=e.byteLength,c=void 0,y=s,d=void 0,w=void 0,b=void 0,g=void 0,k=void 0,E=void 0,A=void 0,m=a;y--;){c=u[y];var T=_slicedToArray(c,7);d=T[0],w=T[1],b=T[2],g=T[3],k=T[4],E=T[5],A=T[6];for(var U=0;U<b;U++){if(m>=o)return null;E?A[U]=e[m++]:k[U]=e[m++]}switch(w){case _:i&&E.reverse();var S=E[0],B=(Math.min(S,o),n.from(e.slice(m,m+S)).toString());m+=S,r[d]=B;break;default:i&&g.byteLength>1&&g.reverse(),r[d]=g[0]}}return r}Array.isArray(e)||(e=[]);for(var o,s=e.length,u=new Array(s),c=new Array(s),f=Object.create(null),l=0,h=!1,y=null,v=null,p=null,d=new Uint16Array(1),w=new Uint8Array(d.buffer),_=1,b=2,g=4,k=8,E=0;E<s;E++){var A=(o=e[E].split(":")).shift(),m=o.shift(),T=function(e){switch(e){case"str":return _;case"int":return b;case"uint":return g;case"float":return k;default:throw new Error("Unknown type: "+e)}}(m.replace(/[\d\[\]]/g,"")),U=function(e,r){switch(e){case _:return[Uint16Array.BYTES_PER_ELEMENT,n.alloc(r||256),new Uint16Array(1)];case b:switch(r){case 8:return[Int8Array.BYTES_PER_ELEMENT,new Int8Array(1)];case 16:return[Int16Array.BYTES_PER_ELEMENT,new Int16Array(1)];case 32:return[Int32Array.BYTES_PER_ELEMENT,new Int32Array(1)];default:throw new Error("Unknown size: "+r)}case g:switch(r){case 8:return[Uint8Array.BYTES_PER_ELEMENT,new Uint8Array(1)];case 16:return[Uint16Array.BYTES_PER_ELEMENT,new Uint16Array(1)];case 32:return[Uint32Array.BYTES_PER_ELEMENT,new Uint32Array(1)];default:throw new Error("Unknown size: "+r)}case k:switch(r){case 32:return[Float32Array.BYTES_PER_ELEMENT,new Float32Array(1)];case 64:return[Float64Array.BYTES_PER_ELEMENT,new Float64Array(1)];default:throw new Error("Unknown size: "+r)}default:throw new Error("Unknown type: "+e)}}(T,parseInt(m.replace(/\D/g,""),10)||0),S=_slicedToArray(U,3),B=S[0],C=S[1],M=S[2],L=_&T?null:new Uint8Array(C.buffer),O=M?new Uint8Array(M.buffer):null;u[E]=[A,T,B,C,L,M,O],l+=B,!h&&_&T&&(h=!0)}return h||(y=new Uint8Array(l+a)),{pack:r,unpack:t}}function r(e,r){return r?r.set(e):r=new Uint16Array(e),r[0]}function t(e,r){return r?(r.set(e),r[0]):e[a-1]}var n="undefined"!=typeof Buffer?Buffer:function(){function e(e,r){r=r||1/0;for(var t=e.length,n=void 0,i=null,a=[],o=0;o<t;++o){if((n=e.charCodeAt(o))>55295&&n<57344){if(!i){if(n>56319){(r-=3)>-1&&a.push(239,191,189);continue}if(o+1===t){(r-=3)>-1&&a.push(239,191,189);continue}i=n;continue}if(n<56320){(r-=3)>-1&&a.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(r-=3)>-1&&a.push(239,191,189);if(i=null,n<128){if((r-=1)<0)break;a.push(n)}else if(n<2048){if((r-=2)<0)break;a.push(n>>6|192,63&n|128)}else if(n<65536){if((r-=3)<0)break;a.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((r-=4)<0)break;a.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return a}function r(e,r,t){t=Math.min(e.length,t);for(var n=[],i=r;i<t;){var a=e[i],o=null,s=a>239?4:a>223?3:a>191?2:1;if(i+s<=t){var u=void 0,f=void 0,l=void 0,h=void 0;switch(s){case 1:a<128&&(o=a);break;case 2:128==(192&(u=e[i+1]))&&(h=(31&a)<<6|63&u)>127&&(o=h);break;case 3:u=e[i+1],f=e[i+2],128==(192&u)&&128==(192&f)&&(h=(15&a)<<12|(63&u)<<6|63&f)>2047&&(h<55296||h>57343)&&(o=h);break;case 4:u=e[i+1],f=e[i+2],l=e[i+3],128==(192&u)&&128==(192&f)&&128==(192&l)&&(h=(15&a)<<18|(63&u)<<12|(63&f)<<6|63&l)>65535&&h<1114112&&(o=h)}}null===o?(o=65533,s=1):o>65535&&(o-=65536,n.push(o>>>10&1023|55296),o=56320|1023&o),n.push(o),i+=s}return c(n)}function t(e){if(e>l)throw new RangeError("Invalid typed array length");return new Uint8Array(e)}function n(r){return e(r).length}function i(e){var r=t(e);return r.write=a,r.swap16=o,r}function a(r,t,n){t=t||0;var i=this.length-t;return(!n||n>i)&&(n=i),s(e(r,this.length-t),this,t,n)}function o(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var r=0;r<e;r+=2)u(this,r,r+1);return this}function s(e,r,t,n){var i=void 0;for(i=0;i<n&&!(i+t>=r.length||i>=e.length);++i)r[i+t]=e[i];return i}function u(e,r,t){var n=e[r];e[r]=e[t],e[t]=n}function c(e){var r=e.length;if(r<=f)return String.fromCharCode.apply(String,e);for(var t="",n=0;n<r;)t+=String.fromCharCode.apply(String,e.slice(n,n+=f));return t}var f=4096,l=2147483647,h=function(){};return h.alloc=i,h.byteLength=n,h.from=function(t){return"string"==typeof t?e(t):{toString:function(){return r(t,0,t.length)}}},h}();Uint8Array.prototype.slice||Object.defineProperty(Uint8Array.prototype,"slice",{value:Array.prototype.slice});var i=function(){var e=new Uint32Array([305419896]);return 18===new Uint8Array(e.buffer,e.byteOffset,e.byteLength)[0]}(),a=3;return{isBigEndian:i,sysOffset:a,createPacket:e,getSize:r,getId:t}}();return function(r,t){function n(r,t){var n=t.data;if(r._emit("message",n,t),!r._emit("arraybuffer",n,t)){var i=n.byteLength;if(n&&n instanceof ArrayBuffer&&!(i<e.sysOffset))for(var a=0,o=n=new Uint8Array(n),u=1048576;a<i&&u--;){var c=s._unpackMapById[e.getId(o)],f=c?e.getSize(o):0;if(!c||!f)break;var l=_slicedToArray(c,2),h=l[0],y=l[1].unpack(o);i>(a+=f)&&(o=n.slice(a)),y&&(r._emit("packet",h,y),r._emit(h,y))}}}function i(e,r){s.reconnecting&&(s.reconnecting=!1,s._emit("restored")),s._emit("open")}function a(e,r){var t=r.code,n=r.reason;s._emit("close",t,n,r),r.wasClean?s._emit("disconnected",t,n,r):(s._emit("terminated",t,r),setTimeout(function(){s.reconnecting=!0,s._reconnect(),s._emit("restoring")},2e3))}function o(e,r){s._emit("error",r)}var s=new(function(t){function s(){_classCallCheck(this,s);var e=_possibleConstructorReturn(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));return r&&e.connect(r),e._packMapByName=new Map,e._unpackMapById=new Array,e.reconnecting=!1,e}return _inherits(s,t),_createClass(s,[{key:"isSupported",value:function(){return"undefined"!=typeof WebSocket}},{key:"emit",value:function(e,r){return(r=this._pack(e,r))&&this.send(r),!!r}},{key:"send",value:function(e){try{this._ws.send(e)}catch(e){this._emit("error",e)}}},{key:"connect",value:function(e){this._ws&&this._ws.close();var r=this._ws=new WebSocket(e);this.url=e,r.binaryType="arraybuffer",r.onmessage=n.bind(this,this),r.onopen=i.bind(this,this),r.onclose=a.bind(this,this),r.onerror=o.bind(this,this)}},{key:"disconnect",value:function(e,r){this._ws.close(e,r),this._ws=null}},{key:"packets",value:function(r,t,n){function i(r,t){r&&Object.keys(r).forEach(function(n){a(n),t(n,e.createPacket(r[n]))})}function a(e){if(["restoring","restored","open","close","disconnected","terminated","packet","message","arraybuffer","error"].some(function(r){return r===e}))throw new Error("Used a reserved name: "+e)}var o=this;return i(t,function(e,r){o._unpackMapById.push([e,r])}),i(r,function(e,r){o._packMapByName.set(e,[o._packMapByName.size,r])}),n?this.packets(n,n):this}},{key:"_reconnect",value:function(){return this.connect(this.url)}},{key:"_pack",value:function(e,r){var t=this._packMapByName.get(e);if(!t)return null;var n=_slicedToArray(t,2),i=n[0];return n[1].pack(i,r)}}]),s}(function(){function e(){_classCallCheck(this,e),this._events=Object.create(null)}return _createClass(e,[{key:"on",value:function(e,r){var t=this._events[e];return this._events[e]="function"==typeof t?[t,r]:t?this._arrayCloneWith(t,t.length,r):r,this}},{key:"off",value:function(e,r){var t=arguments.length;if(!t)return this._events=Object.create(null),this;var n=this._events[e];if("function"==typeof n)return 1!==t&&n!==r||(this._events[e]=null),this;var i=n&&n.length;return i?(1===t?1===i?n.pop():this._events[e]=new Array:1===i?n[0]===r&&n.pop():n.indexOf(r)>=0&&(this._events[e]=this._arrayCloneWithout(n,i,r)),this):this}},{key:"_emit",value:function(e){var r=this._events[e],t="function"==typeof r&&r,n=t||r&&r.length;if(!n){if("error"===e)throw arguments[1];return!1}var i=arguments.length;if(t){switch(i){case 1:t.call(this);break;case 2:t.call(this,arguments[1]);break;case 3:t.call(this,arguments[1],arguments[2]);break;case 4:t.call(this,arguments[1],arguments[2],arguments[3]);break;default:for(var a=new Array(i-1),o=1;o<i;o++)a[o-1]=arguments[o];t.apply(this,a)}return!0}switch(i){case 1:for(var s=0;s<n;s++)r[s].call(this);break;case 2:for(var u=0;u<n;u++)r[u].call(this,arguments[1]);break;case 3:for(var c=0;c<n;c++)r[c].call(this,arguments[1],arguments[2]);break;case 4:for(var f=0;f<n;f++)r[f].call(this,arguments[1],arguments[2],arguments[3]);break;default:for(var l=new Array(i-1),h=1;h<i;h++)l[h-1]=arguments[h];for(var y=0;y<n;y++)r[y].apply(this,l)}return!0}},{key:"_arrayCloneWithout",value:function(e,r,t){for(var n=new Array(--r),i=void 0;r--;)t!==(i=e[r])&&(n[r]=i);return n}},{key:"_arrayCloneWith",value:function(e,r,t){for(var n=new Array(r+1);r--;)n[r]=e[r];return n[r]=t,n}}]),e}()));return s}}();