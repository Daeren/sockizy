"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=function(){function e(e,t){var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){i=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw o}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),io=function(e){function t(e){if(null===e)return"";switch(void 0===e?"undefined":_typeof(e)){case"string":return e;case"undefined":return"";case"boolean":return e?"true":"false";case"number":return isNaN(e)?"":e+"";case"symbol":return e.toString();default:return JSON.stringify(e)}}Uint8Array.prototype.slice||Object.defineProperty(Uint8Array.prototype,"slice",{value:Array.prototype.slice});var r=function(){return function(){function e(){_classCallCheck(this,e),this._events=Object.create(null)}return _createClass(e,[{key:"on",value:function(e,t){var r=this._events[e];return this._events[e]="function"==typeof r?[r,t]:r?this._arrayCloneWith(r,r.length,t):t,this}},{key:"once",value:function(e,t){return this.on(e,function r(){this.off(e,r),t.apply(this,arguments)})}},{key:"off",value:function(e,t){var r=arguments.length;if(!r)return this._events=Object.create(null),this;var n=this._events[e];if("function"==typeof n)return 1!==r&&n!==t||(this._events[e]=null),this;var i=n&&n.length;return i?(1===r?1===i?n.pop():this._events[e]=new Array:1===i?n[0]===t&&n.pop():n.indexOf(t)>=0&&(this._events[e]=this._arrayCloneWithout(n,i,t)),this):this}},{key:"listenerCount",value:function(e){var t=this._events;if(t){var r=t[e];if("function"==typeof r)return 1;if(r)return r.length}return 0}},{key:"_emit",value:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];var i=this._events[e];if(!i){if("error"===e){var o=arguments[1];if(o instanceof Error)throw o;var a=new Error('Unhandled "error" event. ('+o+")");throw a.context=o,a}return!1}if("function"==typeof i)i.apply(this,r);else for(var s=0,u=i.length;s<u;++s)i[s].apply(this,r);return!0}},{key:"_arrayCloneWithout",value:function(e,t,r){for(var n=new Array(t-1),i=void 0,o=0;t--;)r!==(i=e[t])&&(n[o]=i,++o);return n}},{key:"_arrayCloneWith",value:function(e,t,r){var n=new Array(t+1);for(n[t]=r;t--;)n[t]=e[t];return n}}]),e}()}();e.exports=r;var n=function(){function e(e,i,o){function a(e){e=parseInt(e,10)||0,U=U-m+e,m=e,C||(O=new Uint8Array(U))}function s(e,i){var o=Array.isArray(e),a=void 0,s=E,u=m,l=void 0,y=void 0,h=void 0,v=void 0,_=void 0,d=void 0,k=void 0,S=void 0,C=e;for(i=i||O;s--;){l=g[s];var U=_slicedToArray(l,7);if(y=U[0],h=U[1],v=U[2],_=U[3],d=U[4],k=U[5],S=U[6],!w&&e&&(C=e[o?s:y]),h&f||h&c?(h&p&&(C=JSON.stringify(C)),C?(v+=k[0]=h&c?t(C,_,v,C.byteLength):_.write(C,v),(d=_)._bw=v,n?(_[0]=S[1],_[1]=S[0]):(_[0]=S[0],_[1]=S[1])):d=A):null===C||isNaN(C)||!isFinite(C)||void 0===C?_[0]=0:(_[0]=C,n&&_.byteLength>1&&d.reverse()),O)for(a=0;v--;)i[u++]=d[a++];else b[s]=d,u+=v}if(!O){i=i||(N===u?T:(T=r.allocUnsafe(u),N=T.length,T)),s=E,a=m;for(var L=void 0,j=void 0,M=void 0;s--;)for(j=0,M=(L=b[s])._bw||L.length;j<M;)i[a]=L[j],++a,++j}return i}function u(e,t,a,s,u){var l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:!i,y=arguments.length>6&&void 0!==arguments[6]?arguments[6]:o;if(!E)return s&&s(m),null;if(e&&"object"===(void 0===e?"undefined":_typeof(e))&&!(e.byteLength<U)){w||(u=u||(l?y?new Array:Object.create(null):y?k:S));for(var h=void 0,v=E,_=t+m,d=void 0,b=void 0,A=void 0,C=void 0,O=void 0,T=void 0,N=void 0,L=_;v--;){var j=_slicedToArray(g[v],7);d=j[0],b=j[1],A=j[2],C=j[3],O=j[4],T=j[5],N=j[6];for(var M=0;M<A;++M){if(_>=a)return;T?N[M]=e[_++]:O[M]=e[_++]}if(b&f||b&c){n&&N.reverse();var B=T[0];if(!B||B>=a)h=b&c||b&p?null:"";else{for(var P=Math.min(C.length-A,a,B),I=b&c?r.allocUnsafe(P):C,R=0;R<P;++R,++_)I[R]=e[_];if(h=b&c?I:I.toString("utf8",0,P),b&p)try{h=JSON.parse(h)}catch(e){h=null}}}else n&&C.byteLength>1&&O.reverse(),h=C[0];w?u=h:(y&&(d=v),u[d]=h)}return s&&s(m+_-L),u}}var c=1,f=2,l=4,y=8,h=16,p=32;e||(e=[]);var v=!!Array.isArray(e)&&e.some(function(e){return e.split(":").length>=2}),_=!Array.isArray(e)||e.some(function(e){return e.split(":").length<2});if(v&&_)throw new Error("A schema has mixed names/types");_&&(o=!0);for(var d,w="string"==typeof e,E=w?1:e.length,g=new Array(E),b=new Array(E),A=new Uint8Array(2),m=0,k=new Array,S=Object.create(null),C=!1,O=null,T=null,N=0,U=0,L=0,j=0;j<E;++j){var M=(d=w?["",e]:e[j].split(":")).length<2?null:d.shift(),B=d.shift(),P=function(e){switch(e){case"b":case"bin":return c;case"j":case"json":return f|p;case"s":case"str":return f;case"i":case"int":return l;case"u":case"uint":return y;case"f":case"float":return h;default:throw new Error("Unknown type: "+e)}}(B.replace(/[\d\[\]]/g,"")),I=function(e,t){if(e&c)return[Uint16Array.BYTES_PER_ELEMENT,r.allocUnsafeSlow((t||1024)+Uint16Array.BYTES_PER_ELEMENT),new Uint16Array(1)];if(e&p)return[Uint16Array.BYTES_PER_ELEMENT,r.allocUnsafeSlow((t||8192)+Uint16Array.BYTES_PER_ELEMENT),new Uint16Array(1)];if(e&f)return[Uint16Array.BYTES_PER_ELEMENT,r.allocUnsafeSlow((t||256)+Uint16Array.BYTES_PER_ELEMENT),new Uint16Array(1)];switch(e){case l:switch(t){case 8:return[Int8Array.BYTES_PER_ELEMENT,new Int8Array(1)];case 16:return[Int16Array.BYTES_PER_ELEMENT,new Int16Array(1)];case 32:return[Int32Array.BYTES_PER_ELEMENT,new Int32Array(1)];default:throw new Error("Unknown size: "+t)}case y:switch(t){case 8:return[Uint8Array.BYTES_PER_ELEMENT,new Uint8Array(1)];case 16:return[Uint16Array.BYTES_PER_ELEMENT,new Uint16Array(1)];case 32:return[Uint32Array.BYTES_PER_ELEMENT,new Uint32Array(1)];default:throw new Error("Unknown size: "+t)}case h:switch(t){case 32:return[Float32Array.BYTES_PER_ELEMENT,new Float32Array(1)];case 64:return[Float64Array.BYTES_PER_ELEMENT,new Float64Array(1)];default:throw new Error("Unknown size: "+t)}default:throw new Error("Unknown type: "+e)}}(P,parseInt(B.replace(/\D/g,""),10)||0),R=_slicedToArray(I,3),Y=R[0],x=R[1],D=R[2],G=P&(c|f)?null:new Uint8Array(x.buffer),W=D?new Uint8Array(D.buffer):null;g[j]=[M,P,Y,x,G,D,W],U+=Y,L+=x.byteLength,!C&&P&(c|f)&&(C=!0)}return a(0),{get minSize(){return U},get maxSize(){return L},get offset(){return m},set offset(e){a(e)},pack:s,unpack:u}}function t(e,t,r,n){if(!n)return 0;var i=t.length,o=e.length,a=void 0,s=void 0;for(a=0;a<n&&!((s=a+r)>=i||a>=o);++a)t[s]=e[a];return a}var r="undefined"!=typeof Buffer?Buffer:function(){function e(e,t){t=t||1/0;for(var r=e.length,n=void 0,i=null,o=new Array,a=0;a<r;++a){if((n=e.charCodeAt(a))>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(a+1===r){(t-=3)>-1&&o.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&o.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;o.push(n)}else if(n<2048){if((t-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o}function r(e,t,r){r=Math.min(e.length,r);for(var i=new Array,o=t;o<r;){var a=e[o],s=null,u=a>239?4:a>223?3:a>191?2:1;if(o+u<=r){var c=void 0,f=void 0,l=void 0,y=void 0;switch(u){case 1:a<128&&(s=a);break;case 2:128==(192&(c=e[o+1]))&&(y=(31&a)<<6|63&c)>127&&(s=y);break;case 3:c=e[o+1],f=e[o+2],128==(192&c)&&128==(192&f)&&(y=(15&a)<<12|(63&c)<<6|63&f)>2047&&(y<55296||y>57343)&&(s=y);break;case 4:c=e[o+1],f=e[o+2],l=e[o+3],128==(192&c)&&128==(192&f)&&128==(192&l)&&(y=(15&a)<<18|(63&c)<<12|(63&f)<<6|63&l)>65535&&y<1114112&&(s=y)}}null===s?(s=65533,u=1):s>65535&&(s-=65536,i.push(s>>>10&1023|55296),s=56320|1023&s),i.push(s),o+=u}return n(i)}function n(e){var t=e.length;if(t<=i)return String.fromCharCode.apply(String,e);for(var r="",n=0;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=i));return r}var i=4096,o=2147483647;return function(){function n(e){if(e>o)throw new RangeError("Invalid typed array length");var t=new Uint8Array(e);return t.write=u.prototype.write,t.toString=u.prototype.toString,t}function i(t){return e(t).length}function a(r,n,i){n=n||0,i=i||this.length;var o=this.length-n;return(!i||i>o)&&(i=o),t(e(r,this.length-n),this,n,i)}function s(e,t,n){return t=t||0,n=n||this.length,0===n?"":r(this,t,n)}var u=function(){};return u.allocUnsafe=n,u.allocUnsafeSlow=n,u.byteLength=i,u.prototype=Object.create(null),u.prototype.write=a,u.prototype.toString=s,u}()}(),n=function(){var e=new Uint32Array([305419896]);return 18===new Uint8Array(e.buffer,e.byteOffset,e.byteLength)[0]}();return e.isBE=n,e.isLE=!n,e}();e.exports=n,e.exports=t;var i=function(e){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=new l(e,r);return Array.isArray(t.__staticPackets)&&n.packets.apply(n,_toConsumableArray(t.__staticPackets)),n}function r(e,t){function r(e){o+=e}var n=t.data;if(e._emit("message",n,t),"string"!=typeof n){if(!e._emit("arraybuffer",n,t))for(var i=(n=new Uint8Array(n)).byteLength,o=0,a=n;o<i&&"break"!==function(){var t=f.unpack(a,o,i),n=e._unpackMapById[t];if(!n)return"break";var s=_slicedToArray(n,2),u=s[0],c=s[1].unpack(a,o,i,r);if(void 0===c)return"break";e.listenerCount("packet")?e._emit("packet",u,c,function(){return e._emit(u,c)}):e._emit(u,c)}(););}else if(e._emit("text",n,t),e.listenerCount("json")){try{n=JSON.parse(n)}catch(e){n=void 0}void 0!==n&&e._emit("json",n,t)}}function n(e,t){var r=e._reconnectionAttemptsCount;e._reconnectionAttemptsCount=0,e.reconnecting&&(e.reconnecting=!1,e._emit("restored",r)),e._emit("open")}function i(e,t){var r=t.code,n=t.reason;if(e._emit("close",r,n,t),t.wasClean)e._emit("disconnected",r,n,t);else{var i=e._reconnectionAttemptsCount;e._emit("terminated",r,t),i<e._reconnectionAttempts?(e._reconnectionAttemptsCount++,setTimeout(function(){e.reconnecting=!0,e._reconnect(),e._emit("restoring",i)},e._reconnectionDelay)):(e.reconnecting=!1,e._emit("unrestored",i))}}function o(e,t){var r=new Error(t.message||t.data||"");r.event=t,e._emit("error",r)}function a(){return"undefined"==typeof crypto?function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}():function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(e){return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)})}()}var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:require("./../src/toString"),u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:require("./../src/see"),c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:require("2pack"),f=c("uint16"),l=function(t){function u(t,r){_classCallCheck(this,u);var n=_possibleConstructorReturn(this,(u.__proto__||Object.getPrototypeOf(u)).call(this));if(n._reconnectionDelay=1e3*Math.max(1,r.reconnectionDelay||0),n._reconnectionAttempts=r.reconnectionAttempts||1/0,n._reconnectionAttemptsCount=0,n._packMapByName=new Map,n._unpackMapById=new Array,n._id=a(),n.reconnecting=!1,n.CONNECTING=e.CONNECTING,n.OPEN=e.OPEN,n.CLOSING=e.CLOSING,n.CLOSED=e.CLOSED,t){var i=t.trim().split(/(^wss?:\/\/)/i),o=i.pop().replace(/^[:\/\/]*/,""),s=(i.pop()||"").trim(),c=!(!s||!s.match(/^wss:\/\//i)),f=r.secure;void 0===f&&(f=s?c:!!document.location.protocol.match(/^https/i)),n._connect((f?"wss":"ws")+"://"+o+"/?id="+n._id)}return n}return _inherits(u,t),_createClass(u,[{key:"emit",value:function(e,t){return(t=this._pack(e,t))&&this.send(t),!!t}},{key:"text",value:function(e){this.send(s(e))}},{key:"json",value:function(e){this.send(JSON.stringify(e))}},{key:"send",value:function(e){var t=this.readyState,r=void 0;try{t!==this.CLOSING&&t!==this.CLOSED?this._ws.send(e):r=new Error("WebSocket is already in CLOSING or CLOSED state.")}catch(e){r=e}r&&this._emit("error",r)}},{key:"disconnect",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=this.readyState;return r!==this.CLOSING&&r!==this.CLOSED&&this._ws.close(e,t),this}},{key:"packets",value:function(e,t,r){function n(e,t){e&&Object.keys(e).forEach(function(r){var n=r.split(/\(([\[\{]?)(\@?)([\}\]]?)\)$/),o=n.shift().trim(),a="["===n.shift(),s="@"===n.shift(),u=e[r],l=c(u,s,a);l.offset=f.maxSize,i(o),t(o,l)})}function i(e){if(["restoring","restored","open","close","disconnected","terminated","packet","message","arraybuffer","error","ping","pong"].some(function(t){return t===e}))throw new Error("Used a reserved name: "+e)}var o=this;return n(t,function(e,t){o._unpackMapById.push([e,t])}),n(e,function(e,t){o._packMapByName.set(e,[o._packMapByName.size,t])}),r?this.packets(r,r):this}},{key:"_connect",value:function(t){try{this._ws=new e(t)}catch(e){return void this._emit("error",e)}var a=this._ws;a.onmessage=r.bind(a,this),a.onopen=n.bind(a,this),a.onclose=i.bind(a,this),a.onerror=o.bind(a,this),a.binaryType="arraybuffer"}},{key:"_reconnect",value:function(){this._connect(this.url)}},{key:"_pack",value:function(e,t){var r=this._packMapByName.get(e);if(r){var n=_slicedToArray(r,2),i=n[0],o=n[1];return f.pack(i,o.pack(t))}return null}},{key:"bufferedAmount",get:function(){return this._ws&&this._ws.bufferedAmount||0}},{key:"readyState",get:function(){return this._ws&&this._ws.readyState||this.CLOSED}},{key:"url",get:function(){return this._ws&&this._ws.url||""}}]),u}(u);return e?t:null};return e.exports=i,i(window.WebSocket||window.MozWebSocket,t,r,n)}({});